{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://0nork.com/schemas/v1.0.0/0n-file.schema.json",
  "title": ".0n File Specification v1.0.0",
  "description": "The canonical JSON Schema for the .0n file format. Validates all .0n files across the 0n ecosystem including workflows, connections, environments, bundles, vault containers, encrypted payloads, deed transfers, and SWITCH files. Every .0n file MUST carry an Ed25519 signature and SHA-256 content hash. Error handling (on_error, retry, rollback) is mandatory on every file — omission is a structural error.",
  "type": "object",

  "required": [
    "schema_version",
    "file_id",
    "created_at",
    "author",
    "signature",
    "content_hash",
    "manifest",
    "on_error",
    "retry",
    "rollback"
  ],

  "additionalProperties": false,

  "properties": {

    "schema_version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "description": "Semantic version of the .0n schema this file conforms to. MUST follow semver 2.0.0 (e.g. '1.0.0', '1.0.0-beta.1'). Validators use this field to select the correct schema revision."
    },

    "file_id": {
      "type": "string",
      "format": "uuid",
      "description": "Universally unique identifier (UUID v4) for this specific file instance. Used for deduplication, audit trails, transfer registries, and replay prevention. MUST be generated fresh for every new file — never reuse across copies."
    },

    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp recording when this file was originally created. MUST NOT change after initial creation. Used as the canonical anchor for signature verification and chain-of-custody timelines."
    },

    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp of the most recent modification to this file. MUST be updated on every edit. Omitted on files that have never been modified after creation."
    },

    "author": {
      "type": "object",
      "description": "Identity of the entity that created and signed this file. The Ed25519 public key in 'pubkey' is bound to the 'signature' field and MUST be verifiable against a known key registry or out-of-band exchange.",
      "required": ["name", "email", "pubkey"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Display name of the author (person, organization, or system agent)."
        },
        "email": {
          "type": "string",
          "format": "email",
          "description": "Contact email for the author. Used for provenance tracking and notification routing."
        },
        "pubkey": {
          "type": "string",
          "pattern": "^[0-9a-fA-F]{64}$",
          "description": "Ed25519 public key encoded as a 64-character lowercase or uppercase hex string (32 bytes). This key is the identity anchor — the signature field MUST verify against this key."
        }
      }
    },

    "signature": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{128}$",
      "minLength": 128,
      "maxLength": 128,
      "description": "Ed25519 signature of the file content, encoded as a 128-character hex string (64 bytes). The signed payload is the canonical JSON serialization of all file content EXCLUDING the 'signature' field itself. Verification: Ed25519.verify(content_bytes, signature_hex, author.pubkey)."
    },

    "content_hash": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{64}$",
      "minLength": 64,
      "maxLength": 64,
      "description": "SHA-256 hash of the file content at signing time, encoded as a 64-character hex string (32 bytes). Provides a fast integrity check independent of signature verification. MUST be recomputed and compared before trusting file contents."
    },

    "manifest": {
      "type": "object",
      "description": "File identity and classification metadata. The 'type' field determines which optional sections are relevant. Every .0n file carries a manifest regardless of content type.",
      "required": ["type", "name", "version"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "workflow",
            "connection",
            "environment",
            "bundle",
            "vault",
            "encrypted",
            "deed",
            "switch"
          ],
          "description": "Content type discriminator. Determines which optional schema sections apply: 'workflow' enables the workflow section, 'vault' enables the vault section, 'deed' enables the deed section, 'switch' is the master SWITCH profile combining multiple connection and workflow references, 'bundle' packages multiple .0n files, 'encrypted' wraps AES-256-GCM encrypted payloads, 'environment' stores environment variable sets, 'connection' stores single-service credentials."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Human-readable name for this file. Displayed in dashboards, marketplace listings, and CLI output."
        },
        "description": {
          "type": "string",
          "maxLength": 2000,
          "description": "Extended description of what this file contains or does. Supports plain text. Used in marketplace listings, documentation generators, and search indexing."
        },
        "version": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
          "description": "Semantic version of this file's content (not the schema version). Tracks revisions of the workflow, connection, or other payload. Increment on every meaningful change."
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 50,
            "pattern": "^[a-z0-9][a-z0-9_-]*$"
          },
          "uniqueItems": true,
          "maxItems": 30,
          "description": "Classification tags for discovery and filtering. Lowercase alphanumeric with hyphens and underscores. Used by the marketplace, CLI search, and programmatic filtering."
        },
        "license": {
          "type": "string",
          "maxLength": 100,
          "description": "SPDX license identifier (e.g. 'MIT', 'Apache-2.0', 'CC-BY-4.0', 'PROPRIETARY'). Governs redistribution and marketplace listing eligibility."
        }
      }
    },

    "services": {
      "type": "array",
      "description": "Declares external service dependencies this file requires at runtime. Each entry names a service from the 0nMCP catalog (26 services: crm, stripe, sendgrid, slack, discord, twilio, github, shopify, openai, anthropic, gmail, google_sheets, google_drive, airtable, notion, mongodb, supabase, zendesk, jira, hubspot, mailchimp, google_calendar, calendly, zoom, linear, microsoft) and references credentials via vault syntax.",
      "items": {
        "type": "object",
        "required": ["name", "auth_ref"],
        "additionalProperties": false,
        "properties": {
          "name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "Service identifier matching a key in the 0nMCP service catalog (e.g. 'stripe', 'crm', 'supabase'). Case-sensitive."
          },
          "auth_ref": {
            "type": "string",
            "pattern": "^\\{\\{vault:[a-zA-Z0-9_.-]+\\}\\}$",
            "description": "Vault reference for this service's credentials using the {{vault:service_name}} syntax. Resolved at runtime by the 0nVault credential loader from ~/.0n/connections/."
          },
          "scopes": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1,
              "maxLength": 200
            },
            "uniqueItems": true,
            "description": "Permission scopes required from this service (e.g. 'contacts.read', 'payments.write'). Used for OAuth scope negotiation and access verification. Service-specific — consult the 0nMCP catalog for valid scope names."
          },
          "required": {
            "type": "boolean",
            "default": true,
            "description": "Whether this service connection is mandatory for file execution. If true (default), the runtime MUST abort if the credential cannot be resolved. If false, the runtime may proceed with degraded functionality."
          }
        }
      }
    },

    "workflow": {
      "type": "object",
      "description": "Execution logic for workflow-type files. Implements the three-level execution model (Patent Pending): Pipeline (sequential), Assembly Line (parallel stages with dependencies), and Radial Burst (fan-out/fan-in). Each stage maps to a 0nMCP tool invocation or internal action.",
      "required": ["execution_model", "stages"],
      "additionalProperties": false,
      "properties": {
        "execution_model": {
          "type": "string",
          "enum": ["pipeline", "assembly_line", "radial_burst"],
          "description": "Execution strategy for stage orchestration. 'pipeline': strictly sequential, each stage runs after the previous completes. 'assembly_line': stages run in dependency order with maximum parallelism where depends_on allows. 'radial_burst': fan-out all independent stages simultaneously, fan-in at convergence points."
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 3600000,
          "default": 300000,
          "description": "Maximum wall-clock time in milliseconds for the entire workflow execution. Overrides stage-level timeouts. Range: 1 second to 1 hour. Default: 5 minutes."
        },
        "max_parallel": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 10,
          "description": "Maximum number of stages that may execute concurrently in assembly_line or radial_burst mode. Provides backpressure to avoid overwhelming downstream services."
        },
        "stages": {
          "type": "array",
          "minItems": 1,
          "description": "Ordered list of execution stages. In pipeline mode, stages execute in array order. In assembly_line and radial_burst modes, the depends_on field determines execution order. At least one stage is required.",
          "items": {
            "type": "object",
            "required": ["id", "name", "action"],
            "additionalProperties": false,
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9_]{0,63}$",
                "description": "Unique stage identifier within this workflow. Lowercase alphanumeric with underscores, starting with a letter. Referenced by depends_on in other stages and by variable resolution ({{step.stage_id.output.*}})."
              },
              "name": {
                "type": "string",
                "minLength": 1,
                "maxLength": 200,
                "description": "Human-readable label for this stage. Displayed in execution logs, dashboards, and CLI progress output."
              },
              "action": {
                "type": "string",
                "minLength": 1,
                "maxLength": 300,
                "description": "The tool or operation to execute. Can be a 0nMCP tool name (e.g. 'crm_create_contact', 'stripe_create_customer'), an internal action (lookup, set, transform, compute, condition, map), or a sub-workflow reference."
              },
              "service": {
                "type": "string",
                "maxLength": 100,
                "description": "Which service from the services array this stage uses. Must match a services[].name entry. Omit for internal actions that do not call external APIs."
              },
              "inputs": {
                "type": "object",
                "additionalProperties": true,
                "description": "Input parameters passed to the action. Values may contain template expressions using the .0n variable resolution order: {{system.*}} > {{launch.*}} > {{inputs.*}} > {{step.<stage_id>.output.*}}. Vault references ({{vault:service}}) are also resolved here."
              },
              "outputs": {
                "type": "object",
                "additionalProperties": true,
                "description": "Output mapping that names and shapes the data returned by this stage. Downstream stages reference these values via {{step.<stage_id>.output.<key>}}."
              },
              "depends_on": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^[a-z][a-z0-9_]{0,63}$"
                },
                "uniqueItems": true,
                "description": "Stage IDs that must complete successfully before this stage can start. Required for assembly_line and radial_burst execution models. Ignored in pipeline mode (array order determines sequence)."
              },
              "condition": {
                "type": "string",
                "maxLength": 1000,
                "description": "Boolean expression evaluated at runtime to determine whether this stage should execute. Supports template expressions and comparison operators. If the condition evaluates to false, the stage is skipped and downstream dependents see a 'skipped' status."
              },
              "on_error": {
                "type": "string",
                "enum": ["abort", "skip", "retry", "fallback"],
                "description": "Stage-level error handling override. 'abort': halt the entire workflow. 'skip': mark this stage as failed and continue. 'retry': retry according to the top-level retry policy. 'fallback': execute the fallback_action if defined. Overrides the top-level on_error.action for this stage only."
              },
              "fallback_action": {
                "type": "string",
                "maxLength": 300,
                "description": "Alternative action to execute if this stage fails and on_error is set to 'fallback'. Must be a valid tool name or internal action."
              },
              "timeout_ms": {
                "type": "integer",
                "minimum": 100,
                "maximum": 600000,
                "description": "Maximum execution time for this individual stage in milliseconds. Overridden by the workflow-level timeout_ms if that limit is reached first. Range: 100ms to 10 minutes."
              },
              "retry_override": {
                "type": "object",
                "additionalProperties": false,
                "description": "Stage-specific retry configuration that overrides the top-level retry policy for this stage only.",
                "properties": {
                  "max_attempts": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 10,
                    "description": "Maximum retry attempts for this stage."
                  },
                  "backoff": {
                    "type": "string",
                    "enum": ["exponential", "linear", "fixed"],
                    "description": "Backoff strategy for this stage's retries."
                  },
                  "initial_delay_ms": {
                    "type": "integer",
                    "minimum": 50,
                    "maximum": 60000,
                    "description": "Initial delay before the first retry in milliseconds."
                  }
                }
              },
              "metadata": {
                "type": "object",
                "additionalProperties": true,
                "description": "Arbitrary key-value metadata attached to this stage. Not processed by the runtime — reserved for tooling, dashboards, and documentation generators."
              }
            }
          }
        }
      }
    },

    "verify": {
      "type": "object",
      "description": "Seal of Truth verification configuration (Patent #63/968,814). Defines the trust tier, domain classification, and source allowlisting for content integrity verification. When present, the runtime MUST verify the content_hash against the Seal of Truth before execution.",
      "additionalProperties": false,
      "properties": {
        "tier": {
          "type": "string",
          "enum": ["gold", "silver", "bronze"],
          "description": "Trust tier for Seal of Truth verification. 'gold': cryptographically signed by a known authority with full audit trail. 'silver': signed with verified author identity. 'bronze': self-signed with content hash verification only."
        },
        "domain": {
          "type": "string",
          "enum": ["medical", "legal", "financial", "general", "technical"],
          "description": "Subject domain classification for this file. Affects verification strictness — 'medical', 'legal', and 'financial' domains enforce gold-tier verification by default. 'general' and 'technical' accept any tier."
        },
        "source_whitelist": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "uri",
            "description": "Allowed source URI for data referenced by this file."
          },
          "uniqueItems": true,
          "description": "List of trusted source URIs that this file is authorized to fetch data from. The runtime MUST reject requests to any URI not on this list when the verify section is present."
        },
        "callback_url": {
          "type": "string",
          "format": "uri",
          "description": "Webhook URL that receives verification result notifications. The runtime POSTs a JSON payload with file_id, verification_status, and timestamp after each verification attempt."
        },
        "require_signature_chain": {
          "type": "boolean",
          "default": false,
          "description": "When true, the runtime MUST verify an unbroken chain of Ed25519 signatures from the original author through all subsequent modifiers. Enables tamper-evident audit trails for regulated domains."
        }
      }
    },

    "deploy": {
      "type": "object",
      "description": "JSON Smart Deploy configuration (Patent Pending). Controls placeholder resolution, dependency ordering, and rollback targets for automated deployment pipelines. Used by the 0nMCP engine to deploy .0n files into live environments.",
      "additionalProperties": false,
      "properties": {
        "placeholders": {
          "type": "object",
          "additionalProperties": {
            "type": "string",
            "description": "Description of what this placeholder token represents."
          },
          "description": "Map of placeholder token patterns to their descriptions. Tokens use the {{placeholder_name}} syntax and are resolved during deployment from environment variables, vault references, or user input. Example: {\"{{app_name}}\": \"Application display name\", \"{{api_base}}\": \"Base URL for the API\"}."
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "uniqueItems": true,
          "description": "Ordered list of file_ids or file paths that must be deployed before this file. The deploy engine resolves these in order, ensuring prerequisite connections and environments are active before dependent workflows start."
        },
        "dry_run": {
          "type": "boolean",
          "default": false,
          "description": "When true, the deploy engine simulates all operations without making actual changes. Outputs a detailed plan showing what would be created, modified, or deleted. Always run dry_run first in production deployments."
        },
        "rollback_targets": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "uniqueItems": true,
          "description": "List of file_ids or resource identifiers that should be rolled back if this deployment fails. The rollback engine reverses changes in the opposite order they were applied."
        },
        "environment": {
          "type": "string",
          "enum": ["production", "staging", "development", "sandbox"],
          "default": "production",
          "description": "Target deployment environment. Affects which credentials are resolved and which safety checks are enforced."
        },
        "auto_verify": {
          "type": "boolean",
          "default": true,
          "description": "When true, the deploy engine runs Seal of Truth verification on all files before deployment begins. Deployment aborts if any file fails verification."
        }
      }
    },

    "vault": {
      "type": "object",
      "description": "Credential reference declarations for vault-type files or any file that needs to explicitly enumerate its credential dependencies. References are resolved at runtime by the 0nVault credential loader against ~/.0n/connections/.",
      "additionalProperties": false,
      "properties": {
        "references": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["key", "service"],
            "additionalProperties": false,
            "properties": {
              "key": {
                "type": "string",
                "minLength": 1,
                "maxLength": 100,
                "pattern": "^[a-z][a-z0-9_.-]*$",
                "description": "Reference name used in vault syntax: {{vault:<key>}}. Must be unique within this file's references array."
              },
              "service": {
                "type": "string",
                "minLength": 1,
                "maxLength": 100,
                "description": "Service this credential authenticates against. Must match a service name from the 0nMCP catalog."
              },
              "required": {
                "type": "boolean",
                "default": true,
                "description": "Whether this credential is mandatory. If true and the credential cannot be resolved, the runtime MUST abort."
              },
              "scopes": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "uniqueItems": true,
                "description": "Required permission scopes for this credential."
              },
              "fallback_key": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9_.-]*$",
                "description": "Alternative vault key to try if the primary key cannot be resolved. Enables graceful degradation across environments."
              }
            }
          }
        },
        "encryption": {
          "type": "object",
          "additionalProperties": false,
          "description": "Encryption metadata for vault containers (.0nv files).",
          "properties": {
            "algorithm": {
              "type": "string",
              "enum": ["AES-256-GCM", "AES-256-CBC"],
              "default": "AES-256-GCM",
              "description": "Symmetric encryption algorithm used for credential storage."
            },
            "kdf": {
              "type": "string",
              "enum": ["PBKDF2-SHA512", "Argon2id"],
              "default": "PBKDF2-SHA512",
              "description": "Key derivation function. PBKDF2-SHA512 for standard vault, Argon2id for vault container credential layers (double-encrypted)."
            },
            "kdf_iterations": {
              "type": "integer",
              "minimum": 10000,
              "maximum": 1000000,
              "default": 100000,
              "description": "Iteration count for the key derivation function. Higher values increase brute-force resistance at the cost of unlock time."
            },
            "machine_bound": {
              "type": "boolean",
              "default": false,
              "description": "When true, the encryption key incorporates a hardware fingerprint, binding the vault to a specific machine. When false (portable mode), only the passphrase is required."
            }
          }
        }
      }
    },

    "on_error": {
      "type": "object",
      "description": "MANDATORY global error handling policy. Defines the default behavior when any stage or operation fails. Individual stages may override this with their own on_error field. Missing this section is a structural validation error.",
      "required": ["action", "rollback"],
      "additionalProperties": false,
      "properties": {
        "action": {
          "type": "string",
          "enum": ["abort", "skip", "retry", "fallback"],
          "description": "Default error action applied when a stage fails without its own on_error override. 'abort': halt execution immediately and trigger rollback if enabled. 'skip': log the error and continue to the next stage. 'retry': retry the failed stage according to the retry policy. 'fallback': execute the stage's fallback_action if defined, otherwise abort."
        },
        "rollback": {
          "type": "boolean",
          "description": "Whether to trigger the rollback strategy when the error action is 'abort'. If true, the rollback section defines how to reverse completed stages."
        },
        "notify": {
          "type": "string",
          "maxLength": 500,
          "description": "Notification target for error alerts. Can be an email address, Slack channel reference, webhook URL, or service-specific identifier (e.g. 'slack:#ops-alerts', 'email:mike@rocketopp.com')."
        },
        "log_level": {
          "type": "string",
          "enum": ["error", "warn", "info", "debug"],
          "default": "error",
          "description": "Minimum log level recorded when an error occurs. 'debug' captures full request/response payloads for troubleshooting."
        }
      }
    },

    "retry": {
      "type": "object",
      "description": "MANDATORY global retry policy. Defines the default retry behavior for failed stages. Individual stages may override this with retry_override. Missing this section is a structural validation error.",
      "required": ["max_attempts", "backoff", "initial_delay_ms"],
      "additionalProperties": false,
      "properties": {
        "max_attempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Maximum number of retry attempts before the stage is considered permanently failed. The initial execution counts as attempt 1, so max_attempts=3 means up to 2 retries after the first failure. Range: 1-10."
        },
        "backoff": {
          "type": "string",
          "enum": ["exponential", "linear", "fixed"],
          "description": "Backoff strategy between retry attempts. 'exponential': delay doubles each attempt (initial_delay_ms * 2^attempt). 'linear': delay increases by initial_delay_ms each attempt. 'fixed': same delay every attempt."
        },
        "initial_delay_ms": {
          "type": "integer",
          "minimum": 50,
          "maximum": 60000,
          "description": "Delay in milliseconds before the first retry. For exponential backoff, this is the base delay. For linear, this is the increment. For fixed, this is the constant delay. Range: 50ms-60s."
        },
        "max_delay_ms": {
          "type": "integer",
          "minimum": 100,
          "maximum": 300000,
          "default": 30000,
          "description": "Maximum delay cap in milliseconds. Prevents exponential backoff from producing unreasonably long waits. The actual delay will never exceed this value regardless of backoff calculation. Range: 100ms-5min."
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 600000,
          "default": 60000,
          "description": "Maximum total time in milliseconds across all retry attempts for a single stage. If this timeout is reached, the stage fails permanently regardless of remaining attempts. Range: 1s-10min."
        },
        "jitter": {
          "type": "boolean",
          "default": false,
          "description": "When true, adds random jitter (0-25% of calculated delay) to each retry interval. Prevents thundering herd problems when multiple workflows retry simultaneously."
        },
        "retry_on": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Error code or HTTP status code pattern."
          },
          "uniqueItems": true,
          "description": "Restrict retries to specific error codes or HTTP status patterns (e.g. '429', '5xx', 'ECONNRESET', 'TIMEOUT'). If omitted, all errors trigger retries."
        }
      }
    },

    "rollback": {
      "type": "object",
      "description": "MANDATORY rollback configuration. Defines how to reverse completed stages when execution fails and on_error.rollback is true. Missing this section is a structural validation error.",
      "required": ["enabled", "strategy"],
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Master switch for rollback functionality. When false, no rollback occurs even if on_error.rollback is true. Useful for explicitly documenting that a file's operations are not reversible."
        },
        "strategy": {
          "type": "string",
          "enum": ["reverse_order", "selective", "manual"],
          "description": "Rollback execution strategy. 'reverse_order': undo completed stages in the reverse order they executed — most common and safest default. 'selective': only roll back stages marked with rollback_eligible=true. 'manual': log rollback instructions but do not execute automatically — for human review."
        },
        "preserve_logs": {
          "type": "boolean",
          "default": true,
          "description": "When true, execution logs and intermediate outputs are preserved during rollback for post-mortem analysis. When false, logs may be cleaned up as part of the rollback process."
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 600000,
          "default": 120000,
          "description": "Maximum time allowed for the entire rollback operation in milliseconds. If rollback itself times out, the system logs a critical alert and preserves all state for manual intervention."
        },
        "notify_on_rollback": {
          "type": "string",
          "maxLength": 500,
          "description": "Notification target specifically for rollback events. Same format as on_error.notify. If omitted, rollback notifications go to on_error.notify."
        },
        "checkpoints": {
          "type": "boolean",
          "default": false,
          "description": "When true, the runtime captures snapshots of state after each successful stage. Enables partial rollback to the last known good checkpoint instead of full reversal."
        }
      }
    },

    "adapters": {
      "type": "object",
      "description": "Export format mappings for cross-platform compatibility. Defines which AI platform configuration formats this file can be exported to and any per-format field overrides. The 0nMCP engine uses this section to generate platform-specific configs.",
      "additionalProperties": false,
      "properties": {
        "formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "claude_desktop",
              "cursor",
              "vscode",
              "windsurf",
              "gemini",
              "openai",
              "n8n",
              "yaml",
              "continue",
              "cline"
            ]
          },
          "uniqueItems": true,
          "description": "List of export formats this file supports. Each format corresponds to a platform configuration generator in the 0nMCP engine module."
        },
        "overrides": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": true,
            "description": "Per-format field mapping overrides."
          },
          "description": "Per-format override map. Keys are format names from the formats array. Values are objects whose keys are .0n field paths and values are the target platform's equivalent field names or transformed values."
        },
        "default_format": {
          "type": "string",
          "enum": [
            "claude_desktop",
            "cursor",
            "vscode",
            "windsurf",
            "gemini",
            "openai",
            "n8n",
            "yaml",
            "continue",
            "cline"
          ],
          "description": "Default export format used when no format is explicitly specified."
        }
      }
    },

    "federation": {
      "type": "object",
      "description": "MCPFed settings (Patent Pending). Controls how this file participates in federated MCP service discovery and capability advertisement. When enabled, the file's capabilities are registered with the federation mesh.",
      "additionalProperties": false,
      "properties": {
        "register": {
          "type": "boolean",
          "default": false,
          "description": "Whether to register this file's capabilities with the MCPFed discovery mesh. When true, other federated nodes can discover and invoke this file's tools and workflows."
        },
        "capabilities": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "uniqueItems": true,
          "description": "List of capability identifiers advertised to the federation. Other nodes query these when searching for tools that can fulfill a request. Use reverse-domain notation (e.g. 'com.0nork.crm.contacts.create')."
        },
        "discovery": {
          "type": "object",
          "additionalProperties": true,
          "description": "Federation discovery configuration. Contains mesh endpoint URLs, authentication tokens, heartbeat intervals, and routing preferences. Structure varies by federation protocol version."
        },
        "trust_level": {
          "type": "string",
          "enum": ["public", "authenticated", "private"],
          "default": "authenticated",
          "description": "Access control level for federated requests. 'public': any node can invoke. 'authenticated': only nodes with valid federation credentials. 'private': not discoverable, invoke by direct reference only."
        },
        "ttl_seconds": {
          "type": "integer",
          "minimum": 60,
          "maximum": 86400,
          "default": 3600,
          "description": "Time-to-live for the federation registration in seconds. The registration must be renewed before expiry or it is automatically deregistered."
        }
      }
    },

    "deed": {
      "type": "object",
      "description": "Business Deed Transfer settings (Patent Pending, 0nMCP v2.1.0). Configures the packaging, escrow, and transfer of digital business assets via .0nv vault containers. Lifecycle: CREATE > PACKAGE > ESCROW > ACCEPT > IMPORT > FLIP.",
      "additionalProperties": false,
      "properties": {
        "layers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "workflows",
              "credentials",
              "env_vars",
              "mcp_configs",
              "site_profiles",
              "ai_brain",
              "audit_trail"
            ]
          },
          "uniqueItems": true,
          "description": "Vault container semantic layers subject to this deed transfer. Each layer contains a category of digital assets. The 'credentials' layer uses Argon2id double-encryption for additional security."
        },
        "parties": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "pubkey", "role"],
            "additionalProperties": false,
            "properties": {
              "id": {
                "type": "string",
                "minLength": 1,
                "maxLength": 200,
                "description": "Unique identifier for this party (email, organization name, or opaque ID)."
              },
              "pubkey": {
                "type": "string",
                "pattern": "^[0-9a-fA-F]{64}$",
                "description": "X25519 or Ed25519 public key for this party, hex-encoded (32 bytes / 64 characters)."
              },
              "role": {
                "type": "string",
                "enum": ["grantor", "grantee", "escrow_agent", "witness"],
                "description": "Role of this party in the deed transfer. 'grantor': current owner transferring assets. 'grantee': recipient of the transfer. 'escrow_agent': neutral third party holding assets during transfer. 'witness': observer with verification but not access rights."
              },
              "layer_access": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": [
                    "workflows",
                    "credentials",
                    "env_vars",
                    "mcp_configs",
                    "site_profiles",
                    "ai_brain",
                    "audit_trail"
                  ]
                },
                "uniqueItems": true,
                "description": "Per-party access matrix defining which layers this party can decrypt. Escrow agents typically access all layers. Witnesses typically access only audit_trail."
              }
            }
          },
          "maxItems": 8,
          "description": "Parties involved in this deed transfer. Multi-party escrow supports up to 8 parties using X25519 ECDH key agreement."
        },
        "registry_endpoint": {
          "type": "string",
          "format": "uri",
          "description": "Transfer registry endpoint URL. The runtime registers each transfer here with the Seal of Truth hash for replay prevention and chain-of-custody tracking."
        },
        "seal_verification": {
          "type": "boolean",
          "default": true,
          "description": "When true, the runtime computes and verifies the Seal of Truth (SHA3-256) on every container operation. Ensures content-addressed integrity of all layers."
        },
        "transfer_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this specific transfer transaction. Used in the Seal of Truth computation: SHA3-256(transferId || timestamp || pubkey || SHA3-256(concat(ciphertexts))). Populated during the CREATE phase."
        },
        "chain_of_custody": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["timestamp", "action", "actor"],
            "additionalProperties": false,
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "When this custody event occurred."
              },
              "action": {
                "type": "string",
                "enum": ["created", "packaged", "escrowed", "accepted", "imported", "revoked"],
                "description": "The deed lifecycle action that occurred."
              },
              "actor": {
                "type": "string",
                "description": "Identifier of the party that performed this action."
              },
              "signature": {
                "type": "string",
                "pattern": "^[0-9a-fA-F]{128}$",
                "description": "Ed25519 signature of this custody event by the acting party."
              },
              "notes": {
                "type": "string",
                "maxLength": 1000,
                "description": "Optional human-readable notes about this custody event."
              }
            }
          },
          "description": "Append-only chain of custody records tracking every lifecycle event for this deed transfer. Each entry is signed by the acting party."
        }
      }
    },

    "inputs": {
      "type": "object",
      "description": "Input parameter declarations for this file. Defines the expected inputs, their types, defaults, and validation rules. Resolved via {{inputs.*}} template expressions. Primarily used in workflow and switch files.",
      "additionalProperties": {
        "type": "object",
        "required": ["type"],
        "additionalProperties": false,
        "properties": {
          "type": {
            "type": "string",
            "enum": ["string", "number", "integer", "boolean", "object", "array"],
            "description": "Data type of this input parameter."
          },
          "required": {
            "type": "boolean",
            "default": false,
            "description": "Whether this input must be provided at runtime."
          },
          "default": {
            "description": "Default value used when the input is not provided. Must match the declared type."
          },
          "description": {
            "type": "string",
            "maxLength": 500,
            "description": "Human-readable description of what this input is for."
          },
          "pattern": {
            "type": "string",
            "description": "Regex pattern for string-type inputs. The runtime validates the input value against this pattern."
          },
          "enum": {
            "type": "array",
            "items": {},
            "description": "Allowed values for this input. The runtime rejects any value not in this list."
          },
          "minimum": {
            "type": "number",
            "description": "Minimum value for number/integer inputs."
          },
          "maximum": {
            "type": "number",
            "description": "Maximum value for number/integer inputs."
          }
        }
      }
    },

    "outputs": {
      "type": "object",
      "description": "Output declarations for this file. Maps output names to template expressions or static values that are available to consumers after execution completes. Referenced via {{step.<file_id>.output.*}} in downstream files.",
      "additionalProperties": {
        "type": "string",
        "description": "Template expression or static value for this output."
      }
    },

    "environment": {
      "type": "object",
      "description": "Environment variable declarations for environment-type files. Each key is a variable name, and the value is an object describing the variable. Variables may reference vault entries for sensitive values.",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "value": {
            "type": "string",
            "description": "The environment variable value. May contain vault references ({{vault:key}}) that are resolved at runtime."
          },
          "sensitive": {
            "type": "boolean",
            "default": false,
            "description": "When true, this variable contains sensitive data (API keys, passwords, tokens). The runtime MUST mask this value in logs and never expose it in error messages."
          },
          "description": {
            "type": "string",
            "maxLength": 500,
            "description": "Human-readable description of this environment variable."
          },
          "required": {
            "type": "boolean",
            "default": true,
            "description": "Whether this variable must be set for execution to proceed."
          }
        }
      }
    },

    "connection": {
      "type": "object",
      "description": "Service connection configuration for connection-type files. Defines the service, authentication method, and connection options for a single external service.",
      "additionalProperties": false,
      "properties": {
        "service": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Service identifier matching a key in the 0nMCP service catalog."
        },
        "environment": {
          "type": "string",
          "enum": ["production", "sandbox", "development"],
          "default": "production",
          "description": "Target environment for this connection."
        },
        "auth": {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "enum": ["api_key", "oauth2", "basic", "bearer", "custom"],
              "description": "Authentication method for this service."
            },
            "credentials": {
              "type": "object",
              "additionalProperties": true,
              "description": "Credential payload. Structure varies by auth type. Sensitive values SHOULD use vault references."
            },
            "oauth_config": {
              "type": "object",
              "additionalProperties": true,
              "description": "OAuth2-specific configuration: token_url, refresh_url, scopes, client_id reference, etc."
            }
          },
          "description": "Authentication configuration for this service connection."
        },
        "options": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "base_url": {
              "type": "string",
              "format": "uri",
              "description": "Base URL override for this service's API."
            },
            "timeout_ms": {
              "type": "integer",
              "minimum": 1000,
              "maximum": 300000,
              "default": 30000,
              "description": "Connection timeout in milliseconds."
            },
            "rate_limit": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "requests_per_second": {
                  "type": "number",
                  "minimum": 0.1,
                  "description": "Maximum requests per second to this service."
                },
                "burst": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Maximum burst size for the token bucket rate limiter."
                }
              },
              "description": "Rate limiting configuration for this service connection."
            },
            "headers": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              },
              "description": "Additional HTTP headers to include in every request to this service."
            }
          },
          "description": "Connection options and overrides."
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arbitrary metadata for this connection. Not processed by the runtime."
        }
      }
    },

    "bundle": {
      "type": "object",
      "description": "Bundle configuration for bundle-type files that package multiple .0n files together. Defines the included files, resolution order, and bundle-level settings.",
      "additionalProperties": false,
      "properties": {
        "files": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "type"],
            "additionalProperties": false,
            "properties": {
              "path": {
                "type": "string",
                "description": "Relative path to the bundled file from the bundle root."
              },
              "type": {
                "type": "string",
                "enum": ["workflow", "connection", "environment", "vault", "switch"],
                "description": "Type of the bundled file."
              },
              "file_id": {
                "type": "string",
                "format": "uuid",
                "description": "UUID of the bundled file for cross-referencing."
              },
              "required": {
                "type": "boolean",
                "default": true,
                "description": "Whether this file is mandatory for the bundle to function."
              }
            }
          },
          "minItems": 1,
          "description": "List of files included in this bundle."
        },
        "resolution_order": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Ordered list of file paths or file_ids defining the deployment sequence. Files are deployed in this order during bundle installation."
        },
        "compatibility": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "min_0nmcp_version": {
              "type": "string",
              "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
              "description": "Minimum 0nMCP version required to use this bundle."
            },
            "min_spec_version": {
              "type": "string",
              "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
              "description": "Minimum 0n-spec version required to validate this bundle."
            }
          },
          "description": "Version compatibility requirements for this bundle."
        }
      }
    },

    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "description": "Arbitrary key-value metadata for this file. Not processed by the runtime or validators — reserved for tooling, dashboards, marketplace listings, and documentation generators. Common keys: 'marketplace_listing_id', 'execution_count', 'last_executed_at', 'rating'."
    }
  }
}